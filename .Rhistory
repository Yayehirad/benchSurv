E_S = sum(S_i),
V_S = sum(S_i * (1 - S_i)),
.groups = "drop"
)
data %>%
group_by(center) %>%
summarise(n_patients = n(), .groups = "drop") %>%
left_join(patient_agg, by = "center") %>%
left_join(observed_survival, by = "center") %>%
mutate(O_S = S_obs * n_patients)
}
compute_metrics <- function(center_summary) {
center_summary %>%
mutate(
SSR = O_S / E_S,
Z = (O_S - E_S) / sqrt(V_S),
precision = E_S^2 / V_S
) %>%
filter(
is.finite(SSR),
is.finite(precision),
precision > 0
)
}
generate_funnel_limits <- function(metrics, conf_levels) {
precision_seq <- seq(
max(min(metrics$precision, na.rm = TRUE), 0.01),
max(metrics$precision, na.rm = TRUE),
length.out = 100
)
limits <- tibble(precision = precision_seq)
for (conf in conf_levels) {
z <- qnorm((1 + conf) / 2)
limits[[paste0("upper_", conf)]] <- 1 + z / sqrt(precision_seq)
limits[[paste0("lower_", conf)]] <- pmax(0, 1 - z / sqrt(precision_seq))
}
limits
}
create_funnel_plot <- function(metrics, limits, highlight = NULL, conf_levels) {
# Define color and linetype mappings for confidence levels
color_map <- c("80%" = "blue", "95%" = "red")
linetype_map <- c("80%" = "dashed", "95%" = "dotted")
y_min <- min(metrics$SSR, na.rm = TRUE) - 0.1  # Adjust y-axis limit
gg <- ggplot() +
# Plot centers as points with fill = center (shape = 21 allows separate fill and outline)
geom_point(
data = metrics,
aes(x = precision, y = SSR, fill = center),
shape = 21,
color = "black",
size = 3,
alpha = 0.7
) +
# Horizontal reference line
geom_hline(yintercept = 1, color = "grey50", linetype = 2) +
theme_minimal(base_size = 14) +
labs(
title  = "Survival Outcomes Benchmarking",
x      = "Precision (E^2/V)",
y      = "Standardized Survival Ratio",
fill   = "Center",       # legend title for center fills
color  = "Confidence",   # legend title for confidence lines
linetype = "Confidence"
) +
ggplot2::scale_fill_discrete() +
ggplot2::scale_color_manual(values = color_map, drop = FALSE) +
scale_linetype_manual(values = linetype_map, drop = FALSE) +
coord_cartesian(ylim = c(y_min, NA)) +
theme(legend.position = "bottom")
# Plot the upper and lower lines for each confidence level in separate geoms
for (conf in conf_levels) {
conf_label <- paste0(conf * 100, "%")
# Extract upper and lower lines for this conf
upper_df <- tibble::tibble(
precision = limits$precision,
SSR       = limits[[paste0("upper_", conf)]],
conf      = conf_label
)
lower_df <- tibble::tibble(
precision = limits$precision,
SSR       = limits[[paste0("lower_", conf)]],
conf      = conf_label
)
# Plot upper line
gg <- gg + geom_line(
data = upper_df,
aes(x = precision, y = SSR, color = conf, linetype = conf),
size = 1
)
# Plot lower line
gg <- gg + geom_line(
data = lower_df,
aes(x = precision, y = SSR, color = conf, linetype = conf),
size = 1
)
}
# Highlight a center if specified
if (!is.null(highlight)) {
gg <- gg +
geom_point(
data = dplyr::filter(metrics, center == highlight),
aes(x = precision, y = SSR),
shape = 21,
fill = "red",
color = "black",
size = 5,
stroke = 1.3,
show.legend = FALSE
)
}
gg
}
utils::globalVariables(c(
".", "center", "status", "time", "age", "S_i", "n_patients",
"E_S", "V_S", "O_S", "SSR", "Z", "precision", "lp", "S_obs"
))
devtools::document()
devtools::check()
### Load Required Libraries
library(dplyr)
library(survival)
library(ggplot2)
library(lme4)
source("C:/Users/yyay0001/Rpackage/benchSurv/R/benchmark_survival.R")  # Load your package functions
test_data<-read.csv("C:/Users/yyay0001/Rpackage/test_data.csv")
### Inspect Data Structure
str(test_data)
head(test_data)
summary(test_data)
test_data <- test_data %>%
rename(center=SiteShortName,
status=Death,
time=DTime,
age=Age)
### Ensure Required Columns Exist
required_cols <- c("center", "status", "time", "age")
missing_cols <- setdiff(required_cols, names(test_data))
if (length(missing_cols) > 0) {
stop("Missing required columns: ", paste(missing_cols, collapse = ", "))
}
### Run Full Benchmarking Process
benchmark_plot <- benchSurv::benchmark_survival(
data=test_data, center_col = "center", status_col = "status",
time_col = "time", age_col = "age", fixed_time = 36
)
### Inspect Data Structure
str(test_data)
test_data<-read.csv("C:/Users/yyay0001/Rpackage/test_data.csv")
### Inspect Data Structure
str(test_data)
### Run Full Benchmarking Process
benchmark_plot <- benchSurv::benchmark_survival(
data = test_data,
center_col = "SiteShortName",
status_col = "Death",
time_col = "DTime",
fixed_time = 36,  # 3-year survival
covariates = c("Age")  # Include multiple covariates
)
devtools::document()
test_data<-read.csv("C:/Users/yyay0001/Rpackage/test_data.csv")
### Inspect Data Structure
str(test_data)
head(test_data)
summary(test_data)
### Run Full Benchmarking Process
benchmark_plot <- benchSurv::benchmark_survival(
data = test_data,
center_col = "SiteShortName",
status_col = "Death",
time_col = "DTime",
fixed_time = 36,  # 3-year survival
covariates = c("Age")  # Include multiple covariates
)
### Print and Visualize the Output
print(benchmark_plot)  # Display the funnel plot
### Run Full Benchmarking Process
benchmark_plot <- benchSurv::benchmark_survival(
data = test_data,
center_col = "SiteShortName",
status_col = "Death",
time_col = "DTime",
fixed_time = 36,  # 3-year survival
covariates = c("Age"),  # Include multiple covariates
highlight_center = "SiteA"  # Highlight SiteA
)
### Run Full Benchmarking Process
benchmark_plot <- benchSurv::benchmark_survival(
data = test_data,
center_col = "SiteShortName",
status_col = "Death",
time_col = "DTime",
fixed_time = 36,  # 3-year survival
conf_levels = conf_levels ,
covariates = c("Age"),  # Include multiple covariates
highlight_center = "SiteA"  # Highlight SiteA
)
### Run Full Benchmarking Process
benchmark_plot <- benchSurv::benchmark_survival(
data = test_data,
center_col = "SiteShortName",
status_col = "Death",
time_col = "DTime",
fixed_time = 36,  # 3-year survival
conf_levels =c(0.8, 0.95) ,
covariates = c("Age"),  # Include multiple covariates
highlight_center = "SiteA"  # Highlight SiteA
)
### Print and Visualize the Output
print(benchmark_plot)  # Display the funnel plot
### Load Required Libraries
library(dplyr)
library(survival)
library(ggplot2)
devtools::document()
library(lme4)
source("C:/Users/yyay0001/Rpackage/benchSurv/R/benchmark_survival.R")  # Load your package functions
test_data<-read.csv("C:/Users/yyay0001/Rpackage/test_data.csv")
### Inspect Data Structure
str(test_data)
head(test_data)
summary(test_data)
### Run Full Benchmarking Process
benchmark_plot <- benchSurv::benchmark_survival(
data = test_data,
center_col = "SiteShortName",
status_col = "Death",
time_col = "DTime",
fixed_time = 36,  # 3-year survival
conf_levels =c(0.8, 0.95) ,#this is default
covariates = c("Age"),  # Include multiple covariates
highlight_center = "SiteA"  # Highlight SiteA
)
### Run Full Benchmarking Process
benchmark_plot <- benchSurv::benchmark_survival(
data = test_data,
center_col = "SiteShortName",
status_col = "Death",
time_col = "DTime",
fixed_time = 60,  # 3-year survival
conf_levels =c(0.8, 0.95) ,#this is default
covariates = c("Age"),  # Include multiple covariates
highlight_center = "SiteA"  # Highlight SiteA
)
### Print and Visualize the Output
print(benchmark_plot)  # Display the funnel plot
View(benchmark_plot)
devtools::document()
devtools::document()
devtools::check()
remove.packages("benchSurv")
library(benchSurv)
test_data<-read.csv("C:/Users/yyay0001/Rpackage/test_data.csv")
### Inspect Data Structure
str(test_data)
head(test_data)
summary(test_data)
### Run Full Benchmarking Process
benchmark_plot <- benchSurv::benchmark_survival(
data = test_data,
center_col = "SiteShortName",
status_col = "Death",
time_col = "DTime",
fixed_time = 60,  # 3-year survival
conf_levels =c(0.8, 0.95) ,#this is default
covariates = c("Age"),  # Include multiple covariates
highlight_center = "SiteA"  # Highlight SiteA
)
### Print and Visualize the Output
print(benchmark_plot)  # Display the funnel plot
source("C:/Users/yyay0001/Rpackage/benchSurv/R/benchmark_survival.R", echo=TRUE)
source("C:/Users/yyay0001/Rpackage/benchSurv/R/benchmark_survival.R")  # Load your package functions
library(benchSurv)
test_data<-read.csv("C:/Users/yyay0001/Rpackage/test_data.csv")
### Inspect Data Structure
str(test_data)
test_data<-read.csv("C:/Users/yyay0001/Rpackage/test_data.csv")
test_data<-read.csv("C:/Users/yyay0001/Rpackage/bench_resources/test_data.csv")
### Inspect Data Structure
str(test_data)
head(test_data)
summary(test_data)
### Run Full Benchmarking Process
benchmark_plot <- benchSurv::benchmark_survival(
data = test_data,
center_col = "SiteShortName",
status_col = "Death",
time_col = "DTime",
fixed_time = 60,  # 3-year survival
conf_levels =c(0.8, 0.95) ,#this is default
covariates = c("Age"),  # Include multiple covariates
highlight_center = "SiteA"  # Highlight SiteA
)
### Print and Visualize the Output
print(benchmark_plot)  # Display the funnel plot
remove.packages("benchSurv")
source("C:/Users/yyay0001/Rpackage/benchSurv/R/benchmark_survival.R")  # Load your package functions
library(benchSurv)
test_data<-read.csv("C:/Users/yyay0001/Rpackage/bench_resources/test_data.csv")
### Inspect Data Structure
str(test_data)
head(test_data)
summary(test_data)
### Run Full Benchmarking Process
benchmark_plot <- benchSurv::benchmark_survival(
data = test_data,
center_col = "SiteShortName",
status_col = "Death",
time_col = "DTime",
fixed_time = 60,  # 3-year survival
conf_levels =c(0.8, 0.95) ,#this is default
covariates = c("Age"),  # Include multiple covariates
highlight_center = "SiteA"  # Highlight SiteA
)
### Print and Visualize the Output
print(benchmark_plot)  # Display the funnel plot
devtools::document()
library(benchSurv)
remove.packages("benchSurv")
library(benchSurv)
source("C:/Users/yyay0001/Rpackage/benchSurv/R/benchmark_survival.R")  # Load your package functions
### Run Full Benchmarking Process
benchmark_plot <- benchSurv::benchmark_survival(
data = test_data,
center_col = "SiteShortName",
status_col = "Death",
time_col = "DTime",
fixed_time = 60,  # 3-year survival
conf_levels =c(0.8, 0.95) ,#this is default
covariates = c("Age"),  # Include multiple covariates
highlight_center = "SiteA"  # Highlight SiteA
)
### Print and Visualize the Output
print(benchmark_plot)  # Display the funnel plot
test_data<-read.csv("C:/Users/yyay0001/Rpackage/bench_resources/test_data.csv")
### Inspect Data Structure
str(test_data)
head(test_data)
summary(test_data)
### Run Full Benchmarking Process
benchmark_plot <- benchSurv::benchmark_survival(
data = test_data,
center_col = "SiteShortName",
status_col = "Death",
time_col = "DTime",
fixed_time = 60,  # 3-year survival
conf_levels =c(0.8, 0.95) ,#this is default
covariates = c("Age"),  # Include multiple covariates
highlight_center = "SiteA"  # Highlight SiteA
)
### Print and Visualize the Output
print(benchmark_plot)  # Display the funnel plot
devtools::document()
source("C:/Users/yyay0001/Rpackage/benchSurv/R/benchmark_survival.R")  # Load your package functions
test_data<-read.csv("C:/Users/yyay0001/Rpackage/bench_resources/test_data.csv")
### Inspect Data Structure
str(test_data)
head(test_data)
summary(test_data)
### Run Full Benchmarking Process
benchmark_plot <- benchSurv::benchmark_survival(
data = test_data,
center_col = "SiteShortName",
status_col = "Death",
time_col = "DTime",
fixed_time = 60,  # 3-year survival
conf_levels =c(0.8, 0.95) ,#this is default
covariates = c("Age"),  # Include multiple covariates
highlight_center = "SiteA"  # Highlight SiteA
)
### Print and Visualize the Output
print(benchmark_plot)  # Display the funnel plot
source("C:/Users/yyay0001/Rpackage/benchSurv/R/benchmark_survival.R", echo=TRUE)
source("C:/Users/yyay0001/Rpackage/benchSurv/R/benchmark_survival.R")  # Load your package functions
test_data<-read.csv("C:/Users/yyay0001/Rpackage/bench_resources/test_data.csv")
### Inspect Data Structure
str(test_data)
head(test_data)
summary(test_data)
### Run Full Benchmarking Process
benchmark_plot <- benchSurv::benchmark_survival(
data = test_data,
center_col = "SiteShortName",
status_col = "Death",
time_col = "DTime",
fixed_time = 60,  # 3-year survival
conf_levels =c(0.8, 0.95) ,#this is default
covariates = c("Age"),  # Include multiple covariates
highlight_center = "SiteA"  # Highlight SiteA
)
### Print and Visualize the Output
print(benchmark_plot)  # Display the funnel plot
source("C:/Users/yyay0001/Rpackage/benchSurv/R/benchmark_survival.R")  # Load your package functions
library(benchSurv)
source("C:/Users/yyay0001/Rpackage/benchSurv/R/benchmark_survival.R")  # Load your package functions
test_data<-read.csv("C:/Users/yyay0001/Rpackage/bench_resources/test_data.csv")
### Inspect Data Structure
str(test_data)
head(test_data)
summary(test_data)
### Run Full Benchmarking Process
benchmark_plot <- benchSurv::benchmark_survival(
data = test_data,
center_col = "SiteShortName",
status_col = "Death",
time_col = "DTime",
fixed_time = 60,  # 3-year survival
conf_levels =c(0.8, 0.95) ,#this is default
covariates = c("Age"),  # Include multiple covariates
highlight_center = "SiteA"  # Highlight SiteA
)
### Print and Visualize the Output
print(benchmark_plot)  # Display the funnel plot
devtools::document()
source("C:/Users/yyay0001/Rpackage/benchSurv/R/benchmark_survival.R")  # Load your package functions
test_data<-read.csv("C:/Users/yyay0001/Rpackage/bench_resources/test_data.csv")
### Inspect Data Structure
str(test_data)
head(test_data)
summary(test_data)
### Run Full Benchmarking Process
benchmark_plot <- benchSurv::benchmark_survival(
data = test_data,
center_col = "SiteShortName",
status_col = "Death",
time_col = "DTime",
fixed_time = 60,  # 3-year survival
conf_levels =c(0.8, 0.95) ,#this is default
covariates = c("Age"),  # Include multiple covariates
highlight_center = "SiteA"  # Highlight SiteA
)
### Print and Visualize the Output
print(benchmark_plot)  # Display the funnel plot
devtools::document()
source("C:/Users/yyay0001/Rpackage/benchSurv/R/benchmark_survival.R")  # Load your package functions
test_data<-read.csv("C:/Users/yyay0001/Rpackage/bench_resources/test_data.csv")
### Inspect Data Structure
str(test_data)
head(test_data)
summary(test_data)
### Run Full Benchmarking Process
benchmark_plot <- benchSurv::benchmark_survival(
data = test_data,
center_col = "SiteShortName",
status_col = "Death",
time_col = "DTime",
fixed_time = 60,  # 3-year survival
conf_levels =c(0.8, 0.95) ,#this is default
covariates = c("Age"),  # Include multiple covariates
highlight_center = "SiteA"  # Highlight SiteA
)
devtools::document()
source("C:/Users/yyay0001/Rpackage/benchSurv/R/benchmark_survival.R")  # Load your package functions
test_data<-read.csv("C:/Users/yyay0001/Rpackage/bench_resources/test_data.csv")
### Inspect Data Structure
str(test_data)
head(test_data)
summary(test_data)
### Run Full Benchmarking Process
benchmark_plot <- benchSurv::benchmark_survival(
data = test_data,
center_col = "SiteShortName",
status_col = "Death",
time_col = "DTime",
fixed_time = 60,  # 3-year survival
conf_levels =c(0.8, 0.95) ,#this is default
covariates = c("Age"),  # Include multiple covariates
highlight_center = "SiteA"  # Highlight SiteA
)
### Print and Visualize the Output
print(benchmark_plot)  # Display the funnel plot
devtools::document()
devtools::document()
source("C:/Users/yyay0001/Rpackage/benchSurv/R/benchmark_survival.R")  # Load your package functions
test_data<-read.csv("C:/Users/yyay0001/Rpackage/bench_resources/test_data.csv")
### Inspect Data Structure
str(test_data)
head(test_data)
summary(test_data)
### Run Full Benchmarking Process
benchmark_plot <- benchSurv::benchmark_survival(
data = test_data,
center_col = "SiteShortName",
status_col = "Death",
time_col = "DTime",
fixed_time = 60,  # 3-year survival
conf_levels =c(0.8, 0.95) ,#this is default
covariates = c("Age"),  # Include multiple covariates
highlight_center = "SiteA"  # Highlight SiteA
)
### Print and Visualize the Output
print(benchmark_plot)  # Display the funnel plot
devtools::document()
source("C:/Users/yyay0001/Rpackage/benchSurv/R/benchmark_survival.R")  # Load your package functions
test_data<-read.csv("C:/Users/yyay0001/Rpackage/bench_resources/test_data.csv")
### Inspect Data Structure
str(test_data)
head(test_data)
summary(test_data)
### Run Full Benchmarking Process
benchmark_plot <- benchSurv::benchmark_survival(
data = test_data,
center_col = "SiteShortName",
status_col = "Death",
time_col = "DTime",
fixed_time = 60,  # 3-year survival
conf_levels =c(0.8, 0.95) ,#this is default
covariates = c("Age"),  # Include multiple covariates
highlight_center = "SiteA"  # Highlight SiteA
)
### Print and Visualize the Output
print(benchmark_plot)  # Display the funnel plot
